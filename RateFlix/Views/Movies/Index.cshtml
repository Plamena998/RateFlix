@model RateFlix.Core.ViewModels.MoviesIndexViewModel
@{
    ViewData["Title"] = "Movies";
}

<div class="bg-gray-900 min-h-screen py-12">
    <div class="container mx-auto px-6">

        <div class="mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">
                <i class="fas fa-film text-red-500 mr-3"></i>All Movies
            </h1>
            <p class="text-gray-400">Browse @Model.TotalMovies movies</p>
        </div>

        <!-- Filters -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">

                <!-- Search -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Search</label>
                    <input type="text" id="searchInput" value="@Model.Search" placeholder="Search movies..." class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" />
                </div>

                <!-- Genre Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Genre</label>
                    <select id="genreFilter" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        <option value="">All Genres</option>
                        @foreach (var genre in Model.Genres)
                        {
                            <option value="@genre.Id" selected="@(Model.SelectedGenreId == genre.Id)">
                                @genre.Name
                            </option>
                        }
                    </select>
                </div>

                <!-- Year Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Year</label>
                    <select id="yearFilter" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        <option value="">All Years</option>
                        @for (int year = DateTime.Now.Year; year >= 1950; year--)
                        {
                            <option value="@year" selected="@(Model.SelectedYear == year)">@year</option>
                        }
                    </select>
                </div>

                <!-- Sort By -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Sort By</label>
                    <select id="sortByFilter" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        <option value="rating_desc" selected="@(Model.SortBy == "rating_desc" || string.IsNullOrEmpty(Model.SortBy))">Highest Rated</option>
                        <option value="rating_asc" selected="@(Model.SortBy == "rating_asc")">Lowest Rated</option>
                        <option value="year_desc" selected="@(Model.SortBy == "year_desc")">Newest First</option>
                        <option value="year_asc" selected="@(Model.SortBy == "year_asc")">Oldest First</option>
                        <option value="title" selected="@(Model.SortBy == "title")">Title (A-Z)</option>
                    </select>
                </div>

            </div>

            <!-- Reset Button -->
            <div class="mt-4 text-right">
                <button id="resetFilters" class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition">
                    <i class="fas fa-redo mr-2"></i>Reset Filters
                </button>
            </div>
        </div>

        <!-- Movies Grid -->
        <div id="moviesGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 mb-8">
            @foreach (var movie in Model.Movies)
            {
                @await Html.PartialAsync("_MovieCard", movie)
            }
        </div>

        <div id="contentModalContainer"></div>

        <div id="paginationContainer" class="flex justify-center items-center space-x-2 mb-4">
            @if (Model.CurrentPage > 1)
            {
                <button class="pagination-btn px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg" data-page="@(Model.CurrentPage - 1)">Previous</button>
            }

            @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
            {
                <button class="pagination-btn px-4 py-2 rounded-lg @(i == Model.CurrentPage ? "bg-red-500 text-white" : "bg-gray-800 text-white")" data-page="@i">@i</button>
            }

            @if (Model.CurrentPage < Model.TotalPages)
            {
                <button class="pagination-btn px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg" data-page="@(Model.CurrentPage + 1)">Next</button>
            }
        </div>

        <div id="pageInfo" class="text-center text-gray-400">
            Page @Model.CurrentPage of @Model.TotalPages
        </div>

    </div>
</div>

@section Scripts {
    <script>
               $(document).ready(function () {
            let isLoading = false;
            let searchTimeout;

            function loadMovies(page = 1) {
                if (isLoading) return;
                isLoading = true;

                const filters = {
                    search: $('#searchInput').val(),
                    genreId: $('#genreFilter').val(),
                    year: $('#yearFilter').val(),
                    sortBy: $('#sortByFilter').val(),
                    page: page
                };

                $.ajax({
                    url: '@Url.Action("LoadPage", "Movies")',
                    type: 'GET',
                    dataType: 'json',
                    data: filters,
                    success: function (response) {
                        renderMovies(response.movies);
                        updatePagination(response.currentPage, response.totalPages);
                        $('#pageInfo').text(`Page ${response.currentPage} of ${response.totalPages}`);

                        const params = new URLSearchParams(filters);
                        params.set('page', response.currentPage);
                        window.history.replaceState({}, '', '?' + params.toString());

                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    },
                    complete: function () {
                        isLoading = false;
                    }
                });
            }

            function renderMovies(movies) {
                const grid = $('#moviesGrid');
                grid.empty();

                if (!movies || movies.length === 0) {
                    grid.html('<div class="col-span-full text-center py-12 text-gray-400 text-xl">No movies found</div>');
                    return;
                }

                movies.forEach(movie => {
                    let genresHtml = '';
                    if (movie.genres && movie.genres.length > 0) {
                        genresHtml = '<div class="flex flex-wrap gap-1 mt-2">';
                        movie.genres.forEach(genre => {
                            genresHtml += `<span class="bg-red-500 px-2 py-0.5 rounded text-xs text-white">${genre}</span>`;
                        });
                        genresHtml += '</div>';
                    }

                    grid.append(`
                        <div class="movie-card group cursor-pointer transform transition duration-300 hover:scale-105" data-movie-id="${movie.id}">
                            <div class="relative overflow-hidden rounded-lg shadow-lg">
                                <img src="${movie.imageUrl}"
                                     alt="${movie.title}"
                                     class="w-full h-80 object-cover group-hover:opacity-75 transition"
                                     onerror="this.src='https://via.placeholder.com/500x750?text=No+Image'" />
                                <div class="absolute top-2 right-2 bg-yellow-500 text-black px-2 py-1 rounded-full text-sm font-bold imdb-score">
                                    <i class="fas fa-star"></i> ${movie.imdbScore.toFixed(1)}
                                </div>
                                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-4">
                                    <h3 class="font-bold text-lg truncate text-white">${movie.title}</h3>
                                    <p class="text-gray-400 text-sm">${movie.releaseYear} • ${movie.duration} min</p>
                                    ${genresHtml}
                                </div>
                            </div>
                        </div>
                    `);
                });
            }

            function updatePagination(page, total) {
                const container = $('#paginationContainer');
                container.empty();

                if (page > 1) {
                    container.append(`<button class="pagination-btn px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg transition" data-page="${page-1}">Previous</button>`);
                }

                for (let i = Math.max(1, page-2); i <= Math.min(total, page+2); i++) {
                    const activeClass = i === page ? 'bg-red-500 text-white' : 'bg-gray-800 text-white hover:bg-gray-700';
                    container.append(`<button class="pagination-btn px-4 py-2 rounded-lg transition ${activeClass}" data-page="${i}">${i}</button>`);
                }

                if (page < total) {
                    container.append(`<button class="pagination-btn px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg transition" data-page="${page+1}">Next</button>`);
                }
            }

            // Search with debounce
            $('#searchInput').on('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => loadMovies(1), 500);
            });

            // Filter changes
            $('#genreFilter, #yearFilter, #sortByFilter').on('change', function() {
                loadMovies(1);
            });

            // Reset filters
            $('#resetFilters').on('click', function() {
                $('#searchInput').val('');
                $('#genreFilter').val('');
                $('#yearFilter').val('');
                $('#sortByFilter').val('rating_desc');
                loadMovies(1);
            });

            // Pagination
            $(document).on('click', '.pagination-btn', function(e) {
                e.preventDefault();
                const page = parseInt($(this).data('page'));
                loadMovies(page);
            });

            // Movie card click - open modal
            $(document).on('click', '.movie-card', function() {
                const movieId = $(this).data('movie-id');
                loadContentModal(movieId, 'Movies');
            });
        });
    </script>
}
