@model RateFlix.Models.ViewModels.Admin.AdminUsersIndexViewModel
@{
    ViewData["Title"] = "User Management";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<!-- Header -->
<div class="mb-6">
    <h1 class="text-3xl font-bold text-white mb-2">User Management</h1>
    <p class="text-gray-400">Manage all users in the system (@Model.TotalUsers total)</p>
</div>

<!-- Filters -->
<div class="bg-gray-800 rounded-lg p-4 mb-6">
    <form asp-controller="AdminUsers" asp-action="Index" method="get" class="grid grid-cols-1 md:grid-cols-3 gap-4">

        <!-- Search -->
        <input type="text" name="search" value="@Model.Search" placeholder="Search by username or email..."
               class="bg-gray-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />

        <!-- Status Filter -->
        <select name="status" class="bg-gray-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">All Users</option>
            <option value="active" selected="@(Model.Status == "active")">Active Only</option>
            <option value="banned" selected="@(Model.Status == "banned")">Banned Only</option>
        </select>

        <!-- Buttons -->
        <div class="flex gap-2">
            <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold transition">
                <i class="fas fa-search mr-2"></i>Search
            </button>
            @if (!string.IsNullOrEmpty(Model.Search) || !string.IsNullOrEmpty(Model.Status))
            {
                <a asp-controller="AdminUsers" asp-action="Index" class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-semibold transition">
                    <i class="fas fa-times"></i>
                </a>
            }
        </div>
    </form>
</div>

<!-- Success/Error Messages -->
@if (TempData["Success"] != null)
{
    <div class="bg-green-500 text-white px-6 py-3 rounded-lg mb-6">
        <i class="fas fa-check-circle mr-2"></i>@TempData["Success"]
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="bg-red-500 text-white px-6 py-3 rounded-lg mb-6">
        <i class="fas fa-exclamation-circle mr-2"></i>@TempData["Error"]
    </div>
}

<!-- Users Table -->
<div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
    <table class="w-full">
        <thead class="bg-gray-700">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">User</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Email</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Joined</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Reviews</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Favorites</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Status</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase">Actions</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-700">
            @foreach (var user in Model.Users)
            {
                <tr class="hover:bg-gray-700 transition">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-lg font-bold">
                                @user.UserName.Substring(0, 1).ToUpper()
                            </div>
                            <div>
                                <p class="text-white font-semibold">@user.UserName</p>
                                @if (user.IsAdmin)
                                {
                                    <span class="bg-yellow-500 text-black px-2 py-0.5 rounded text-xs font-bold">ADMIN</span>
                                }
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-gray-300">@user.Email</td>
                    <td class="px-6 py-4 text-gray-300">@user.CreatedAt.ToString("MMM dd, yyyy")</td>
                    <td class="px-6 py-4">
                        <span class="bg-gray-700 text-white px-3 py-1 rounded font-semibold">
                            @user.TotalReviews
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="bg-gray-700 text-white px-3 py-1 rounded font-semibold">
                            @user.TotalFavorites
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        @if (user.IsBanned)
                        {
                            <span class="bg-red-500 text-white px-3 py-1 rounded font-bold text-sm">
                                <i class="fas fa-ban mr-1"></i>BANNED
                            </span>
                        }
                        else
                        {
                            <span class="bg-green-500 text-white px-3 py-1 rounded font-bold text-sm">
                                <i class="fas fa-check mr-1"></i>ACTIVE
                            </span>
                        }
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex items-center justify-end gap-2">
                            <a asp-controller="AdminUsers" asp-action="Details" asp-route-id="@user.Id"
                               class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded transition text-sm">
                                <i class="fas fa-eye"></i>
                            </a>

                            @if (user.IsBanned)
                            {
                                <form asp-action="UnbanUser" asp-route-id="@user.Id" method="post" class="inline">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded transition text-sm">
                                        <i class="fas fa-unlock"></i>
                                    </button>
                                </form>
                            }
                            else
                            {
                                <form asp-action="BanUser" asp-route-id="@user.Id" method="post" class="inline">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded transition text-sm"
                                            onclick="return confirm('Ban this user?')">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                </form>
                            }

                            <button onclick="confirmDelete('@user.Id', '@user.UserName')"
                                    class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded transition text-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Pagination -->
@if (Model.TotalPages > 1)
{
    <div class="flex justify-center items-center gap-2 mt-6">
        @if (Model.CurrentPage > 1)
        {
            <a href="?search=@Model.Search&status=@Model.Status&page=@(Model.CurrentPage - 1)"
               class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded">
                <i class="fas fa-chevron-left"></i>
            </a>
        }

        @for (int i = 1; i <= Model.TotalPages; i++)
        {
            <a href="?search=@Model.Search&status=@Model.Status&page=@i"
               class="@(i == Model.CurrentPage ? "bg-blue-500" : "bg-gray-800 hover:bg-gray-700") text-white px-4 py-2 rounded">
                @i
            </a>
        }

        @if (Model.CurrentPage < Model.TotalPages)
        {
            <a href="?search=@Model.Search&status=@Model.Status&page=@(Model.CurrentPage + 1)"
               class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded">
                <i class="fas fa-chevron-right"></i>
            </a>
        }
    </div>
}

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center">
    <div class="bg-gray-800 rounded-xl p-6 max-w-md w-full">
        <h3 class="text-xl font-bold text-white mb-4">Confirm Delete</h3>
        <p class="text-gray-300 mb-6">
            Are you sure you want to permanently delete user "<span id="userName" class="font-bold"></span>"?
            <br><br>
            <span class="text-red-400">This action cannot be undone!</span>
        </p>
        <div class="flex gap-4">
            <button onclick="closeDeleteModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded">
                Cancel
            </button>
            <form id="deleteForm" method="post" class="flex-1">
                @Html.AntiForgeryToken()
                <button type="submit" class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                    Delete User
                </button>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function confirmDelete(id, username) {
            document.getElementById('userName').textContent = username;
            var form = document.getElementById('deleteForm');
            form.action = '@Url.Action("Delete", "AdminUsers")/' + id;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
        }
    </script>
}